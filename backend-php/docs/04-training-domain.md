# Training Domain Design

## Overview
The Training domain manages training plans, planned sessions, plan compliance tracking, and training adjustments.

## Aggregate Root: PlanSnapshot

### Properties
- `id: int` - Primary key
- `userId: int` - Foreign key to User
- `snapshotJson: string` - Serialized PlanSnapshot data (JSON)
- `windowStartIso: string` - Start date of plan window (ISO format)
- `windowEndIso: string` - End date of plan window (ISO format)
- `createdAt: DateTime`

### Relationships
- `user: User` - Owner of the plan

### Business Rules
- Indexed on `(userId, windowStartIso)` for efficient queries
- Fallback index on `userId` for latest plan lookup
- Multiple plans can exist per user (different windows)
- Plan snapshot contains all planned sessions for the window

## Value Object: PlanSnapshot

Deserialized structure of `snapshotJson`:

```php
class PlanSnapshot
{
    public string $windowStartIso; // ISO timestamp
    public string $windowEndIso; // ISO timestamp
    public array $days; // PlanSnapshotDay[]
}
```

## Value Object: PlanSnapshotDay

```php
class PlanSnapshotDay
{
    public string $dateKey; // Format: 'YYYY-MM-DD' (not full ISO)
    public string $type; // 'easy', 'long', 'tempo', 'interval', 'rest'
    public ?int $plannedDurationMin;
    public ?float $plannedDistanceKm;
    public ?string $plannedIntensity; // 'easy', 'moderate', 'hard'
}
```

## Value Object: PlanCompliance

Tracks how well actual workouts match planned sessions:

```php
class PlanCompliance
{
    public string $status; // 'OK', 'MINOR_DEVIATION', 'MAJOR_DEVIATION'
    public ?float $durationRatio; // actual / planned
    public ?float $distanceRatio; // actual / planned
    public bool $overshootDuration;
    public bool $undershootDuration;
    public bool $overshootDistance;
    public bool $undershootDistance;
    public bool $overshootIntensity;
    public bool $undershootIntensity;
    public bool $wrongSessionType;
    public bool $skippedPlannedSession;
}
```

### Compliance Rules
- **Duration**: < 70% = MAJOR, 70-85% = MINOR, 85-115% = OK, > 130% = MAJOR
- **Intensity**: Hard→Easy = MAJOR, Moderate→Easy = MINOR, Easy→Hard = MINOR
- **Session Type**: Planned interval/tempo but executed as easy = MAJOR
- **Skip**: Planned session not executed = MAJOR

## Value Object: TrainingAdjustments

Generated training recommendations:

```php
class TrainingAdjustment
{
    public string $code; // 'reduce_load', 'increase_load', etc.
    public string $severity; // 'low', 'medium', 'high'
    public string $rationale;
    public array $evidence; // Array of {key, value} pairs
    public ?array $params; // Additional parameters
}

class TrainingAdjustments
{
    public string $generatedAtIso;
    public int $windowDays;
    public array $adjustments; // TrainingAdjustment[]
}
```

## Repository Interface: PlanSnapshotRepository

```php
interface PlanSnapshotRepositoryInterface
{
    public function findById(int $id): ?PlanSnapshot;
    public function findByUserId(int $userId): array;
    public function findByUserIdAndWindow(int $userId, string $fromIso, string $toIso): ?PlanSnapshot;
    public function findLatestByUserId(int $userId): ?PlanSnapshot;
    public function save(PlanSnapshot $snapshot): PlanSnapshot;
    public function delete(PlanSnapshot $snapshot): void;
}
```

## Domain Services

### PlanComplianceEvaluator
Evaluates compliance between planned and actual workouts:
- Compares planned session with executed workout
- Returns PlanCompliance with status and flags
- Deterministic evaluation (same input = same output)

### TrainingAdjustmentsCalculator
Generates training adjustments based on:
- Training signals (fatigue, load, consistency)
- Plan compliance history
- User profile constraints

### TrainingContextBuilder
Builds training context for AI plan generation:
- Aggregates workouts for time window
- Computes training signals
- Includes user profile constraints

## API Contracts

### GET /api/plan-snapshots
List plan snapshots for authenticated user.

### GET /api/plan-snapshots/{id}
Get plan snapshot by ID.

### POST /api/plan-snapshots
Create new plan snapshot (typically generated by AI).

### GET /api/training-context
Get training context for current user (for AI plan generation).

### GET /api/training-adjustments
Get training adjustments for current user.

